<html>
<head>
	<meta charset="utf-8"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css"  crossorigin=""/>
	<!-- Make sure you put this AFTER Leaflet's CSS -->
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" crossorigin=""></script>
	<script src="http://code.jquery.com/jquery-2.1.1.min.js"></script>
	
	<style>
		#mapid 
		{ 
			height: 100%; 
			width: 100%;
		}
	</style>
	<title>Airbender - Air Quality Monitoring Sensor Data</title>
</head>
<body>
	<center>
		<div id="mapid">
		 </div>
	</center>
	<script>
		
		var maplayer="osm" //can be "osm" or "mapbox"
		var mymap = L.map('mapid').setView([25.509815,77.201317 ], 6);

		function onMapClick(e) {
			popup
				.setLatLng(e.latlng)
				.setContent("You clicked the map at " + e.latlng.toString())
				.openOn(mymap);
		}
		
		mymap.on('click', onMapClick);

		
		//Functions to get tile laters
		function getosmmap(){ //add a tile layer to add to our map, in this case it's the 'standard' OpenStreetMap.org tile server
			osmmap=L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
            maxZoom: 18
			})
			return osmmap
		
		}
		
		function getmapboxmap(){ //add a tile layer to add to our map, in this case it's the MapBox tile server
			mapboxmap=L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
			attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
			maxZoom: 18,
			id: 'mapbox.streets',
			accessToken: 'pk.eyJ1IjoiYXJqdW52ZW4iLCJhIjoiY2phN3ptODN4MDEzMTMybG8xM2t1bzltZCJ9.1HxRGkovlxUEqMNHlMmDmw'
				})
			return mapboxmap
		}
		
		//Selecting tile layer
		if (maplayer=="osm"){
			tilelayer=getosmmap()
		}
		else if (maplayer=="mapbox"){
			tilelayer=getmapboxmap()
		}
		
		//Adding the selected tile layer
		//tilelayer.addTo(mymap);
		mymap.addLayer(tilelayer);
		// load device list in GeoJSON from an external file
		
		function getDevIcon(url){
			jsonurl=url+"/feed.json"
			//console.log(jsonurl)
			
			var devicon=L.icon({
						iconUrl: 'icons/pointer1.png',
						iconSize: [20,20]
					})
			
			//console.log(devicon.options.iconUrl)
			return devicon
				
		}
		var url="https://spreadsheets.google.com/feeds/list/1mBWTyAp3tCnuunrK1Rbptb4rGDwByqX4NyUe8kxmR5Q/od6/public/basic?alt=json"
	
		 $.getJSON(url, function(data) {
			
			  var entry = data.feed.entry;
			  devices=[]
			  $(entry).each(function(){
				
					template={
								"geometry" : {"type":"Point","coordinates":[]},
								"type" : "Feature",
								"properties" : {}
					}
					template['properties']['id']=this.title.$t
					//console.log({this.content.$t})
					valuepairs=this.content.$t.split(",")
					//console.log(valuepairs)
					$(valuepairs).each(function(){
							key=$.trim(this.split(": ")[0]);
							value=$.trim(this.split(": ")[1]);
							
							
							
							template['properties'][key]=value;
					});
					template['geometry']['coordinates']=[template['properties']['longitude'],template['properties']['latitude']]
					//console.log(template)
					devices.push(template)
					
					//$('.results').prepend('<h2>'+this.title.$t+'</h2><p>'+this.content.$t.split(",") +'</p>');
			  });
		  
			 console.log(devices)
			 markerlayer=L.geoJson(devices, {
				onEachFeature : function(device,layer){
					icon=getDevIcon(device['properties']['URL'])
					layer.setIcon(icon)
					layer.bindPopup("<b>"+device['properties']['id']+"</b><br><a href='"+device['properties']['url']+"' target='_blank'>Datafeed</a>");
				}
			}).addTo(mymap);
		 });

		/*
		jsonfile="data/devlist.json"
		$.getJSON(jsonfile,function(data){
			
			
			devices=data['features']
			//Create the marker layer
			markerlayer=L.geoJson(devices, {
				onEachFeature : function(device,layer){
					icon=getDevIcon(device['properties']['URL'])
					layer.setIcon(icon)
					layer.bindPopup("<b>"+device['properties']['DevName']+"</b><br><a href='"+device['properties']['URL']+"' target='_blank'>Datafeed</a>");
				}
			}).addTo(mymap);
		});
		*/
		var popup = L.popup();
		
		
	</script>

</body>
</html>
